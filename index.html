<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WA Cepat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4.0.0/dist/tesseract.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .progress-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #f97316; /* Orange-500 for a pop of color */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gradient-to-br from-yellow-100 to-orange-400 p-4 text-gray-800">

    <div id="main-container" class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm text-center border border-gray-200 transition-all duration-500">
        <!-- Tampilan Awal -->
        <div id="initial-view">
            <h1 class="text-3xl md:text-4xl font-bold text-orange-600 mb-2">WA CEPAT</h1>
            <p class="text-gray-600 mb-6">Silakan pilih gambar yang berisi nomer idpel, nomer G dan nomer HP pelanggan.</p>
            
            <label for="image-upload" class="cursor-pointer">
                <div class="flex flex-col items-center justify-center bg-gray-100 border-2 border-dashed border-gray-300 rounded-xl p-6 hover:bg-gray-200 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-orange-600 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.858-1.715A2 2 0 0110.106 4h3.788a2 2 0 011.664.89l.858 1.715a2 2 0 001.664.89H21a2 2 0 012 2v10a2 2 0 01-2 2H3a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="text-sm font-semibold text-gray-600">Pilih Gambar</span>
                </div>
                <input type="file" id="image-upload" class="hidden" accept="image/*">
            </label>
        </div>
        
        <!-- Loading Spinner -->
        <div id="loading-spinner" class="hidden text-center flex flex-col items-center">
            <div class="progress-spinner mb-4"></div>
            <p id="progress-percentage" class="mt-2 text-sm font-bold text-gray-600"></p>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                <div id="progress-bar" class="bg-orange-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="mt-2 text-sm text-gray-600">Mohon tunggu, sedang diproses.</p>
        </div>

        <!-- Tampilan Hasil -->
        <div id="result-view" class="hidden text-left mt-4">
            <div class="bg-white border-2 border-orange-500 rounded-xl p-4 mb-4 flex justify-between items-center shadow-md">
                <p class="text-sm text-gray-600">Nomor Meter/ID Pelanggan:</p>
                <p id="meter-result" class="text-sm font-bold text-gray-800"></p>
            </div>
            
            <div class="bg-white border-2 border-orange-500 rounded-xl p-4 mb-4 flex justify-between items-center shadow-md">
                <p class="text-sm text-gray-600">Nomor Gangguan:</p>
                <p id="g-result" class="text-sm font-bold text-gray-800"></p>
            </div>
            
            <div class="bg-white border-2 border-orange-500 rounded-xl p-4 mb-6 flex justify-between items-center shadow-md">
                <p class="text-sm text-gray-600">Nomor HP Pelanggan:</p>
                <p id="hp-result" class="text-sm font-bold text-gray-800"></p>
            </div>

            <div class="flex flex-col space-y-3">
                <button id="req-ct-btn" class="w-full bg-green-500 text-white font-semibold py-3 px-4 rounded-full hover:bg-green-600 transition-colors duration-200 shadow-md">
                    Req CT
                </button>
                <button id="hubungi-btn" class="w-full bg-green-500 text-white font-semibold py-3 px-4 rounded-full hover:bg-green-600 transition-colors duration-200 shadow-md">
                    Hubungi Pelanggan
                </button>
            </div>
            
            <div class="mt-8 text-center">
                <img id="uploaded-image" src="#" alt="Gambar yang diunggah" class="hidden rounded-xl border border-gray-300 w-[90%] mx-auto object-contain shadow-md">
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const uploadInput = document.getElementById('image-upload');
            const initialView = document.getElementById('initial-view');
            const resultView = document.getElementById('result-view');
            const meterResult = document.getElementById('meter-result');
            const gResult = document.getElementById('g-result');
            const hpResult = document.getElementById('hp-result');
            const loadingSpinner = document.getElementById('loading-spinner');
            const progressPercentage = document.getElementById('progress-percentage');
            const progressText = document.getElementById('progress-text');
            const progressBar = document.getElementById('progress-bar');
            const uploadedImage = document.getElementById('uploaded-image');
            const reqCTBtn = document.getElementById('req-ct-btn');
            const hubungiBtn = document.getElementById('hubungi-btn');

            let nomorMeter = "";
            let nomorG = "";
            let nomorHp = "";

            // Fungsi OCR yang telah direfaktor
            async function performOCR(imagePath) {
                progressText.textContent = 'Memproses OCR...';
                loadingSpinner.classList.remove('hidden');

                try {
                    const { data: { text } } = await Tesseract.recognize(
                        imagePath,
                        'eng', 
                        {
                            logger: m => {
                                // Mengupdate teks progres berdasarkan status
                                if (m.status === 'initializing' || m.status === 'loading') {
                                    progressText.textContent = 'Memuat model inti...';
                                } else if (m.status === 'loading tessdata') {
                                    progressText.textContent = 'Memuat data bahasa...';
                                } else if (m.status === 'recognizing text') {
                                    const progress = Math.round(m.progress * 100);
                                    progressText.textContent = `Menganalisis teks: ${progress}%`;
                                    progressPercentage.textContent = `${progress}%`;
                                    progressBar.style.width = `${progress}%`;
                                }
                            }
                        }
                    );

                    // Menghilangkan spinner dan teks secara instan setelah selesai
                    progressText.textContent = 'Selesai!';
                    loadingSpinner.classList.add('hidden');
                    
                    // Regex untuk mencari pola
                    const meterRegex = /\b(5220\d{8,})\b/;
                    const gRegex = /\b(G\s?\d{6,})\b/i;
                    const hpRegex = /\b(62\d{9,12})\b/;

                    // Cari kecocokan
                    const meterMatch = text.match(meterRegex);
                    const gMatch = text.match(gRegex);
                    const hpMatch = text.match(hpRegex);

                    return {
                        nomorMeter: meterMatch ? meterMatch[1] : "Tidak ditemukan",
                        nomorG: gMatch ? gMatch[1].replace(/\s/g, '') : "Tidak ditemukan",
                        nomorHp: hpMatch ? hpMatch[1] : "Tidak ditemukan"
                    };

                } catch (err) {
                    console.error("Kesalahan OCR:", err);
                    showNotification("Gagal memproses gambar. Mohon coba lagi.", "error");
                    loadingSpinner.classList.add('hidden');
                    initialView.classList.remove('hidden');
                    uploadedImage.classList.add('hidden');
                    return null;
                }
            }

            // Event listener utama
            uploadInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                initialView.classList.add('hidden');
                resultView.classList.add('hidden');
                
                // Tampilkan gambar yang diunggah
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImage.src = e.target.result;
                    uploadedImage.classList.remove('hidden');
                };
                reader.readAsDataURL(file);

                const result = await performOCR(file);

                if (result) {
                    nomorMeter = result.nomorMeter;
                    nomorG = result.nomorG;
                    nomorHp = result.nomorHp;

                    meterResult.textContent = nomorMeter;
                    gResult.textContent = nomorG;
                    hpResult.textContent = nomorHp;

                    resultView.classList.remove('hidden');

                    progressBar.classList.remove('bg-orange-600');
                    progressBar.classList.add('bg-green-500');
                    progressPercentage.textContent = '100%';
                }
            });

            // Fungsi untuk menampilkan notifikasi in-app
            function showNotification(message, type) {
                const notification = document.createElement('div');
                notification.textContent = message;
                notification.className = `p-3 mb-4 rounded-xl text-sm font-medium ${type === 'error' ? 'text-red-700 bg-red-100 border border-red-200' : 'text-green-700 bg-green-100 border border-green-200'}`;
                const container = document.getElementById('main-container');
                container.insertBefore(notification, container.firstChild);
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }

            // Handler tombol "Req CT"
            reqCTBtn.addEventListener('click', () => {
                if (nomorMeter === "Tidak ditemukan" || nomorG === "Tidak ditemukan") {
                    showNotification("Nomor meter atau nomor gangguan tidak ditemukan.", "error");
                    return;
                }
                const message = encodeURIComponent(
                    `*FORMAT PERMINTAAN CLEAR TEMPER*\n\n` +
                    `ID Pelanggan/Nomor Meter : ${nomorMeter}\n` +
                    `Nomor gangguan/PK : ${nomorG}\n` +
                    `Keterangan: kwh meter periksa.`
                );
                const whatsappUrl = `https://wa.me/?text=${message}`;
                window.open(whatsappUrl, '_blank');
            });

            // Handler tombol "Hubungi Pelanggan"
            hubungiBtn.addEventListener('click', () => {
                if (nomorHp === "Tidak ditemukan") {
                    showNotification("Nomor HP pelanggan tidak ditemukan.", "error");
                    return;
                }
                
                const now = new Date();
                const hour = now.getHours();
                let salam = "Selamat Siang";
                if (hour >= 5 && hour < 12) {
                    salam = "Selamat Pagi";
                } else if (hour >= 18 || hour < 5) {
                    salam = "Selamat Malam";
                }

                const message = encodeURIComponent(
                    `${salam}, Terimakasih telah menggunakan layanan PLN. Ada yang bisa kami bantu?`
                );
                const whatsappUrl = `https://wa.me/${nomorHp}?text=${message}`;
                window.open(whatsappUrl, '_blank');
            });
        });
    </script>
</body>
</html>


